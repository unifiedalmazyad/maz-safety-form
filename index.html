<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAZ Safety Form</title>
  <style>
    :root{--bg:#0b1220;--card:#121b2f;--muted:#93a4c7;--txt:#eaf0ff;--line:#24304d;--ok:#18a957;--warn:#f0b429;--bad:#e5484d;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Tahoma,Arial;background:linear-gradient(180deg,#0a1020,#070b14);color:var(--txt);}
    .wrap{max-width:900px;margin:0 auto;padding:16px;}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:8px 0 14px;flex-wrap:wrap}
    .badge{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.02)}
    .card{background:rgba(18,27,47,.9);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1 1 240px}
    .k{font-size:12px;color:var(--muted);margin-bottom:4px}
    .v{font-size:14px;word-break:break-word}
    .qtitle{font-size:16px;line-height:1.7;margin:6px 0 10px}
    .qmeta{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .pill{font-size:12px;color:var(--muted);border:1px dashed var(--line);padding:4px 8px;border-radius:999px}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    button{cursor:pointer;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--txt);padding:10px 12px;border-radius:12px;font-size:14px}
    button.primary{background:rgba(24,169,87,.18);border-color:rgba(24,169,87,.35)}
    button.warn{background:rgba(240,180,41,.14);border-color:rgba(240,180,41,.35)}
    button.danger{background:rgba(229,72,77,.14);border-color:rgba(229,72,77,.35)}
    button:disabled{opacity:.45;cursor:not-allowed}
    .input, textarea{width:100%;box-sizing:border-box;border:1px solid var(--line);background:rgba(0,0,0,.18);color:var(--txt);padding:10px 12px;border-radius:12px;font-size:14px}
    textarea{min-height:86px;resize:vertical}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .footer{display:flex;gap:10px;justify-content:space-between;align-items:center;margin-top:12px;flex-wrap:wrap}
    .progress{font-size:12px;color:var(--muted)}
    .toast{margin-top:10px;font-size:13px;color:var(--muted)}
    .err{color:#ffd1d1}
    .ok{color:#c6ffe0}
    .hide{display:none}
    .qgrid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:860px){ .qgrid{grid-template-columns:1fr 1fr;} }
    .qcard{background:rgba(18,27,47,.85);border:1px solid var(--line);border-radius:16px;padding:14px}
    .req{color:#ffd18a;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="badge" id="modeBadge">MAZ Safety Form</div>
      <div class="badge" id="langBadge"></div>
    </div>

    <div class="card" id="infoCard">
      <div class="row">
        <div class="col"><div class="k">Visit ID</div><div class="v" id="visitIdV">-</div></div>
        <div class="col"><div class="k">Work ID</div><div class="v" id="workIdV">-</div></div>
        <div class="col"><div class="k">TG ID</div><div class="v" id="tgIdV">-</div></div>
      </div>
      <div class="sep"></div>
      <div class="row">
        <div class="col"><div class="k">Type</div><div class="v" id="typeV">-</div></div>
        <div class="col"><div class="k">Status</div><div class="v" id="statusV">Loading…</div></div>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="card" id="qCard">
      <div class="qtitle" id="qText">Loading…</div>
      <div class="hint" id="qHint"></div>

      <div style="height:10px"></div>
      <div class="qgrid" id="questionsList"></div>

      <div class="sep"></div>
      <div class="footer">
        <div class="progress" id="progressTxt">-</div>
        <div class="btns">
          <button class="warn" id="submitBtn">إرسال</button>
        </div>
      </div>

      <div class="toast" id="toast"></div>
    </div>
  </div>

<script>
/*** CONFIG ***/
const FORMS_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRVzVaXmgsKgqc9Xvi22N8aUI1x-F2U1pVrcvK_cS02t0pNC4QaOk6ThsIPXLfMbXI3BDiyTy0JT7wI/pub?gid=471739737&single=true&output=csv";

// إرسال واحد فقط (كل الإجابات دفعة وحدة)
const SUBMIT_ENTRY_WEBHOOK_URL =
  "https://almazyad1.app.n8n.cloud/webhook/submit-entry";

/*** Helpers ***/
const qs = new URLSearchParams(location.search);
const visitId = (qs.get("visitId") || "").trim();
const workId  = (qs.get("workId")  || "").trim();
const tgId    = (qs.get("tgId")    || "").trim();
const type    = ((qs.get("type")   || "ENTRY").trim().toUpperCase());
const lang    = ((qs.get("lang")   || "AR").trim().toUpperCase());

const $ = (id)=>document.getElementById(id);

function setRTL(){
  const isAR = (lang === "AR");
  document.documentElement.lang = isAR ? "ar" : "en";
  document.documentElement.dir  = isAR ? "rtl" : "ltr";
  $("langBadge").textContent = `Lang: ${lang}`;
}
setRTL();

function toast(msg, ok=true){
  $("toast").className = "toast " + (ok ? "ok" : "err");
  $("toast").textContent = msg || "";
}
function isoNow(){ return new Date().toISOString(); }

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

function parseCSV(text){
  // CSV بسيط (يدعم "" داخل الحقول)
  const rows = [];
  let row = [], cur = "", inQ = false;
  for (let i=0;i<text.length;i++){
    const c = text[i], n = text[i+1];
    if (c === '"' && inQ && n === '"'){ cur += '"'; i++; continue; }
    if (c === '"'){ inQ = !inQ; continue; }
    if (c === ',' && !inQ){ row.push(cur); cur=""; continue; }
    if ((c === '\n' || c === '\r') && !inQ){
      if (cur.length || row.length){ row.push(cur); rows.push(row); }
      cur=""; row=[];
      if (c === '\r' && n === '\n') i++;
      continue;
    }
    cur += c;
  }
  if (cur.length || row.length){ row.push(cur); rows.push(row); }
  const header = (rows.shift() || []).map(h=>h.trim());
  return rows
    .filter(r=>r.some(x=>String(x||"").trim()!==""))
    .map(r=>{
      const o={};
      header.forEach((h,idx)=>o[h]= (r[idx] ?? "").trim());
      return o;
    });
}

function withinActiveWindow(q){
  const now = new Date();
  const from = q.Active_From ? new Date(q.Active_From) : null;
  const to   = q.Active_To   ? new Date(q.Active_To)   : null;
  if (from && !isNaN(from) && now < from) return false;
  if (to && !isNaN(to) && now > to) return false;
  return true;
}

function pickText(q){
  if (lang === "EN") return q["Text_EN"] || q["Text_AR"] || q["Text_UR"] || "";
  if (lang === "UR") return q["Text_UR"] || q["Text_AR"] || q["Text_EN"] || "";
  return q["Text_AR"] || q["Text_EN"] || q["Text_UR"] || "";
}

function normYN(v){
  v = String(v||"").trim().toUpperCase();
  if (["Y","YES","TRUE","1"].includes(v)) return "Y";
  if (["N","NO","FALSE","0"].includes(v)) return "N";
  return v;
}

function fileToBase64(file){
  return new Promise((res, rej)=>{
    const r = new FileReader();
    r.onload = ()=>res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}

/*** Bind header ***/
$("visitIdV").textContent = visitId || "(missing)";
$("workIdV").textContent  = workId  || "(missing)";
$("tgIdV").textContent    = tgId    || "(missing)";
$("typeV").textContent    = type;
$("modeBadge").textContent = `MAZ Safety Form • ${type}`;

/*** Required param rule (A) **/
function requireParamsOk(){
  return !!visitId; // visitId required
}

let questions = [];

function buildQuestionCard(q){
  const inputType = (q.Input_Type || "yesno").trim().toLowerCase();
  const isPhotoOnly = (inputType === "photo");

  // طلبك: إذا Input_Type photo => ما يحتاج كتابة نهائياً
  let needNote  = isPhotoOnly ? false : (normYN(q.Require_Note)  === "Y");
  let needPhoto = (normYN(q.Require_Photo) === "Y") || isPhotoOnly;

  const qc = document.createElement("div");
  qc.className = "qcard";
  qc.dataset.qid = q.Question_ID;

  const meta = [];
  if (q.Category) meta.push(`Category: ${q.Category}`);
  if (normYN(q.Is_Critical)==="Y") meta.push("CRITICAL");
  meta.push(`ID: ${q.Question_ID}`);

  const metaDiv = document.createElement("div");
  metaDiv.className = "qmeta";
  metaDiv.innerHTML = meta.map(x=>`<span class="pill">${escapeHtml(x)}</span>`).join("");

  const title = document.createElement("div");
  title.className = "qtitle";
  title.textContent = pickText(q) || q.Question_ID;

  const req = document.createElement("div");
  req.className = "req";
  const reqParts = [];
  reqParts.push(lang==="AR" ? "إجابة مطلوبة" : "Answer required");
  if (needPhoto) reqParts.push(lang==="AR" ? "صورة مطلوبة" : "Photo required");
  if (needNote)  reqParts.push(lang==="AR" ? "ملاحظة مطلوبة" : "Note required");
  req.textContent = reqParts.join(" • ");

  const area = document.createElement("div");
  area.style.marginTop = "10px";

  // Answer
  if (isPhotoOnly){
    const hidden = document.createElement("input");
    hidden.type = "hidden";
    hidden.dataset.role = "answer";
    hidden.value = "PHOTO";
    area.appendChild(hidden);
  } else if (["yesno","yn","bool"].includes(inputType)){
    const hidden = document.createElement("input");
    hidden.type = "hidden";
    hidden.dataset.role = "answer";
    hidden.value = "";

    const btnWrap = document.createElement("div");
    btnWrap.className = "btns";

    const mk = (label, val, cls="")=>{
      const b = document.createElement("button");
      b.type = "button";
      b.textContent = label;
      if (cls) b.className = cls;
      b.onclick = ()=>{
        hidden.value = val;
        [yes,no,nok].forEach(x=>x.style.outline="none");
        b.style.outline = "2px solid rgba(255,255,255,.35)";
        updateProgress();
      };
      return b;
    };

    const yes = mk(lang==="AR"?"نعم":"Yes","YES","primary");
    const no  = mk(lang==="AR"?"لا":"No","NO","");
    const nok = mk(lang==="AR"?"غير مطابق":"NOK","NOK","danger");
    btnWrap.append(yes,no,nok);

    area.appendChild(btnWrap);
    area.appendChild(hidden);

    const hint = document.createElement("div");
    hint.className="hint";
    hint.textContent = (lang==="AR") ? "اختر إجابة." : "Choose an answer.";
    area.appendChild(hint);
  } else {
    const inp = document.createElement(inputType === "textarea" ? "textarea" : "input");
    inp.dataset.role = "answer";
    if (inp.tagName === "INPUT"){
      inp.className = "input";
      inp.type = (["text","number","date","time"].includes(inputType)) ? inputType : "text";
      inp.addEventListener("input", updateProgress);
    } else {
      inp.addEventListener("input", updateProgress);
    }
    area.appendChild(inp);
  }

  // Note (مسموح فقط إذا مو photo-only)
  if (needNote){
    const lab = document.createElement("div");
    lab.className="k"; lab.style.marginTop="10px";
    lab.textContent = (lang==="AR") ? "ملاحظة" : "Note";
    const note = document.createElement("textarea");
    note.dataset.role = "note";
    note.addEventListener("input", updateProgress);
    area.append(lab, note);
  }

  // Photo
  if (needPhoto){
    const lab = document.createElement("div");
    lab.className="k"; lab.style.marginTop="10px";
    lab.textContent = (lang==="AR") ? "صورة" : "Photo";

    const file = document.createElement("input");
    file.type = "file";
    file.accept = "image/*";
    file.className = "input";
    file.dataset.role = "photo";
    file.addEventListener("change", updateProgress);

    const hint = document.createElement("div");
    hint.className="hint";
    hint.textContent = (lang==="AR")
      ? "ارفع صورة (مطلوبة حسب إعداد السؤال)."
      : "Upload a photo (required per question settings).";

    area.append(lab, file, hint);
  }

  qc.append(metaDiv, title, req, area);
  return qc;
}

function updateProgress(){
  const list = $("questionsList");
  const cards = Array.from(list.querySelectorAll(".qcard[data-qid]"));

  let filled = 0;
  for (const q of questions){
    const card = cards.find(c => c.dataset.qid === q.Question_ID);
    if (!card) continue;

    const inputType = (q.Input_Type || "yesno").trim().toLowerCase();
    const isPhotoOnly = (inputType === "photo");
    const needNote  = isPhotoOnly ? false : (normYN(q.Require_Note)  === "Y");
    const needPhoto = (normYN(q.Require_Photo) === "Y") || isPhotoOnly;

    const ansEl = card.querySelector('[data-role="answer"]');
    const noteEl = card.querySelector('[data-role="note"]');
    const fileEl = card.querySelector('[data-role="photo"]');

    let ok = true;

    const ansVal = (ansEl?.value || "").trim();
    if (!ansVal) ok = false;

    if (needNote){
      const noteVal = (noteEl?.value || "").trim();
      if (!noteVal) ok = false;
    }

    if (needPhoto){
      const hasFile = !!(fileEl && fileEl.files && fileEl.files[0]);
      if (!hasFile) ok = false;
    }

    if (ok) filled++;
  }

  $("progressTxt").textContent =
    (lang==="AR")
      ? `مكتمل: ${filled} / ${questions.length}`
      : `Completed: ${filled} / ${questions.length}`;
}

function renderAll(){
  const list = $("questionsList");
  list.innerHTML = "";

  if (!questions.length){
    $("statusV").textContent = "NO QUESTIONS";
    $("qText").textContent = (lang==="AR") ? "لا توجد أسئلة مطابقة." : "No matching questions.";
    $("qHint").textContent = "";
    $("submitBtn").disabled = true;
    $("progressTxt").textContent = "";
    return;
  }

  $("statusV").textContent = "READY";
  $("qText").textContent = (lang==="AR") ? "الأسئلة المفعّلة" : "Enabled Questions";
  $("qHint").textContent = (lang==="AR")
    ? "كل سؤال إجابته مطلوبة. ثم اضغط إرسال."
    : "All answers are required. Then press Submit.";

  questions.forEach(q => list.appendChild(buildQuestionCard(q)));
  $("submitBtn").disabled = false;
  $("submitBtn").onclick = submitAll;

  updateProgress();
}

async function submitAll(){
  const list = $("questionsList");
  const cards = Array.from(list.querySelectorAll(".qcard[data-qid]"));

  // تحقق إلزامي (A) + تجهيز الإجابات
  const answers = [];

  for (const q of questions){
    const card = cards.find(c => c.dataset.qid === q.Question_ID);
    if (!card) continue;

    const inputType = (q.Input_Type || "yesno").trim().toLowerCase();
    const isPhotoOnly = (inputType === "photo");

    const needNote  = isPhotoOnly ? false : (normYN(q.Require_Note)  === "Y");
    const needPhoto = (normYN(q.Require_Photo) === "Y") || isPhotoOnly;

    // answer
    const ansEl = card.querySelector('[data-role="answer"]');
    let answer = (ansEl?.value || "").trim();

    // note
    const noteEl = card.querySelector('[data-role="note"]');
    const note = (noteEl?.value || "").trim();

    // photo
    const fileEl = card.querySelector('[data-role="photo"]');
    let photoBase64 = "";
    if (fileEl && fileEl.files && fileEl.files[0]){
      photoBase64 = await fileToBase64(fileEl.files[0]);
    }

    // إلزاميات
    if (!answer){
      toast((lang==="AR")?`الإجابة مطلوبة للسؤال: ${q.Question_ID}`:`Answer required for: ${q.Question_ID}`, false);
      card.scrollIntoView({behavior:"smooth", block:"center"});
      return;
    }

    if (needNote && !note){
      toast((lang==="AR")?`الملاحظة مطلوبة للسؤال: ${q.Question_ID}`:`Note required for: ${q.Question_ID}`, false);
      card.scrollIntoView({behavior:"smooth", block:"center"});
      return;
    }

    if (needPhoto && !photoBase64){
      toast((lang==="AR")?`الصورة مطلوبة للسؤال: ${q.Question_ID}`:`Photo required for: ${q.Question_ID}`, false);
      card.scrollIntoView({behavior:"smooth", block:"center"});
      return;
    }

    // photo-only: answer ثابت PHOTO (احتياط)
    if (isPhotoOnly) answer = "PHOTO";

    answers.push({
      questionId: q.Question_ID,
      answer,
      note: isPhotoOnly ? "" : note,
      photoBase64,
      savedAt: isoNow()
    });
  }

  // إرسال إلى n8n (submit-entry)
  try{
    toast((lang==="AR")?"جارٍ الإرسال…":"Submitting…", true);

    const r = await fetch(SUBMIT_ENTRY_WEBHOOK_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        visitId, workId, tgId, type,
        submittedAt: isoNow(),
        answers
      })
    });

    const text = await r.text();
    let j = null;
    try { j = text ? JSON.parse(text) : null; } catch {}

    if (!r.ok || (j && j.ok === false)){
      toast((lang==="AR")?"فشل الإرسال":"Submit failed", false);
      return;
    }

    toast((lang==="AR")?"تم الإرسال ✅":"Submitted ✅", true);
    $("statusV").textContent = "SUBMITTED";
    $("submitBtn").disabled = true;

  }catch(e){
    toast((lang==="AR")?"فشل الاتصال":"Connection failed", false);
  }
}

async function loadQuestions(){
  if (!requireParamsOk()){
    $("statusV").textContent = "ERROR";
    $("qText").textContent = (lang==="AR")
      ? "الرابط ناقص (visitId مطلوب)."
      : "Missing parameter (visitId required).";
    $("qHint").textContent = "";
    $("questionsList").innerHTML = "";
    $("submitBtn").disabled = true;
    $("progressTxt").textContent = "";
    return;
  }

  $("statusV").textContent = "LOADING…";
  toast((lang==="AR")?"تحميل الأسئلة…":"Loading questions…", true);

  const res = await fetch(FORMS_CSV_URL, { cache:"no-store" });
  const txt = await res.text();
  const rows = parseCSV(txt);

  const filtered = rows
    .filter(r => String(r.Form_Type||"").trim().toUpperCase() === type)
    .filter(r => normYN(r.Enabled) === "Y")
    .filter(withinActiveWindow)
    .sort((a,b)=> Number(a.Order||0) - Number(b.Order||0));

  questions = filtered;

  toast("", true);
  renderAll();
}

loadQuestions();
</script>
</body>
</html>
